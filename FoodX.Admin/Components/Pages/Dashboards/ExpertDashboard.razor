@page "/dashboard/expert"
@using FoodX.Admin.Data
@using FoodX.Admin.Models
@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Authorization
@inject FoodXDbContext DbContext
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@attribute [Authorize(Roles = "Expert,Admin,SuperAdmin")]
@rendermode InteractiveServer

<PageTitle>Expert Dashboard - FoodX</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudGrid>
        <MudItem xs="12">
            <MudText Typo="Typo.h3" GutterBottom="true">
                <MudIcon Icon="@Icons.Material.Filled.School" Class="mr-2" Style="vertical-align: middle;" />
                Expert Dashboard
            </MudText>
            <MudText Typo="Typo.body1" Class="mb-4">Share expertise, provide consultations, and ensure quality standards</MudText>
        </MudItem>

        <!-- Key Metrics -->
        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudIcon Icon="@Icons.Material.Filled.Assignment" Color="Color.Primary" Style="font-size: 3rem;" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_consultationsCompleted</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Consultations Completed</MudText>
                    <MudText Typo="Typo.caption">@_consultationsThisMonth this month</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudIcon Icon="@Icons.Material.Filled.Verified" Color="Color.Success" Style="font-size: 3rem;" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_certificationsIssued</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Certifications Issued</MudText>
                    <MudText Typo="Typo.caption">Quality verified</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudIcon Icon="@Icons.Material.Filled.QuestionAnswer" Color="Color.Warning" Style="font-size: 3rem;" />
                    <MudText Typo="Typo.h4" Class="mt-2">@_pendingRequests</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Pending Requests</MudText>
                    <MudText Typo="Typo.caption" Color="Color.Warning">Requires attention</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem xs="12" sm="6" md="3">
            <MudCard>
                <MudCardContent>
                    <MudIcon Icon="@Icons.Material.Filled.Star" Color="Color.Info" Style="font-size: 3rem;" />
                    <MudText Typo="Typo.h4" Class="mt-2">4.8</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Average Rating</MudText>
                    <MudText Typo="Typo.caption">From @_totalReviews reviews</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <!-- Quick Actions -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h5" GutterBottom="true">Quick Actions</MudText>
                <MudGrid Class="mt-3">
                    <MudItem xs="12" sm="6">
                        <MudButton Variant="Variant.Filled" Color="Color.Primary" StartIcon="@Icons.Material.Filled.VideoCall" 
                                   FullWidth="true" Href="/consultations/schedule">
                            Schedule Consultation
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudButton Variant="Variant.Filled" Color="Color.Secondary" StartIcon="@Icons.Material.Filled.AssignmentTurnedIn" 
                                   FullWidth="true" Href="/certifications/issue">
                            Issue Certification
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudButton Variant="Variant.Filled" Color="Color.Success" StartIcon="@Icons.Material.Filled.Article" 
                                   FullWidth="true" Href="/knowledge/create">
                            Create Article
                        </MudButton>
                    </MudItem>
                    <MudItem xs="12" sm="6">
                        <MudButton Variant="Variant.Filled" Color="Color.Warning" StartIcon="@Icons.Material.Filled.Assessment" 
                                   FullWidth="true" Href="/audits/perform">
                            Perform Audit
                        </MudButton>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>

        <!-- Expertise Areas -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h5" GutterBottom="true">Your Expertise Areas</MudText>
                <MudChipSet T="string">
                    <MudChip T="string" Color="Color.Primary" Icon="@Icons.Material.Filled.Science">Food Safety</MudChip>
                    <MudChip T="string" Color="Color.Secondary" Icon="@Icons.Material.Filled.Nature">Organic Certification</MudChip>
                    <MudChip T="string" Color="Color.Success" Icon="@Icons.Material.Filled.HealthAndSafety">HACCP</MudChip>
                    <MudChip T="string" Color="Color.Warning" Icon="@Icons.Material.Filled.Security">Quality Control</MudChip>
                    <MudChip T="string" Color="Color.Info" Icon="@Icons.Material.Filled.Biotech">GMO Testing</MudChip>
                    <MudChip T="string" Color="Color.Default" Icon="@Icons.Material.Filled.LocalFlorist">Sustainability</MudChip>
                </MudChipSet>
                <MudButton Variant="Variant.Text" Color="Color.Primary" Class="mt-3" StartIcon="@Icons.Material.Filled.Edit">
                    Update Expertise
                </MudButton>
            </MudPaper>
        </MudItem>

        <!-- Pending Consultation Requests -->
        <MudItem xs="12">
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h5" GutterBottom="true">Pending Consultation Requests</MudText>
                <MudSimpleTable Hover="true" Bordered="true" Striped="true">
                    <thead>
                        <tr>
                            <th>Company</th>
                            <th>Type</th>
                            <th>Topic</th>
                            <th>Requested Date</th>
                            <th>Priority</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>Fresh Foods Ltd</td>
                            <td>Supplier</td>
                            <td>HACCP Implementation</td>
                            <td>@DateTime.Now.AddDays(-1).ToString("MMM dd")</td>
                            <td><MudChip T="string" Color="Color.Error" Size="Size.Small">High</MudChip></td>
                            <td>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">Accept</MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Default" Size="Size.Small">Reschedule</MudButton>
                            </td>
                        </tr>
                        <tr>
                            <td>Green Farms Co</td>
                            <td>Producer</td>
                            <td>Organic Certification</td>
                            <td>@DateTime.Now.AddDays(-2).ToString("MMM dd")</td>
                            <td><MudChip T="string" Color="Color.Warning" Size="Size.Small">Medium</MudChip></td>
                            <td>
                                <MudButton Variant="Variant.Text" Color="Color.Primary" Size="Size.Small">Accept</MudButton>
                                <MudButton Variant="Variant.Text" Color="Color.Default" Size="Size.Small">Reschedule</MudButton>
                            </td>
                        </tr>
                    </tbody>
                </MudSimpleTable>
            </MudPaper>
        </MudItem>

        <!-- Knowledge Base Contributions -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h5" GutterBottom="true">Your Recent Articles</MudText>
                <MudList T="string">
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Article">
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <MudText Typo="Typo.body1">Best Practices for Cold Chain Management</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Published 3 days ago - 245 views</MudText>
                            </div>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                        </div>
                    </MudListItem>
                    <MudListItem T="string" Icon="@Icons.Material.Filled.Article">
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <MudText Typo="Typo.body1">Understanding Food Safety Regulations 2024</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary">Published 1 week ago - 412 views</MudText>
                            </div>
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" Size="Size.Small" />
                        </div>
                    </MudListItem>
                </MudList>
                <MudButton Variant="Variant.Text" Color="Color.Primary" StartIcon="@Icons.Material.Filled.Add">
                    Write New Article
                </MudButton>
            </MudPaper>
        </MudItem>

        <!-- Upcoming Schedule -->
        <MudItem xs="12" md="6">
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h5" GutterBottom="true">Upcoming Schedule</MudText>
                <MudTimeline TimelineOrientation="TimelineOrientation.Vertical">
                    <MudTimelineItem Color="Color.Primary" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.body1">Consultation - ABC Foods</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">Tomorrow, 10:00 AM</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Secondary" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.body1">Site Audit - XYZ Warehouse</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@DateTime.Now.AddDays(2).ToString("MMM dd"), 2:00 PM</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                    <MudTimelineItem Color="Color.Success" Size="Size.Small">
                        <ItemContent>
                            <MudText Typo="Typo.body1">Webinar - Food Safety Standards</MudText>
                            <MudText Typo="Typo.body2" Color="Color.Secondary">@DateTime.Now.AddDays(3).ToString("MMM dd"), 3:00 PM</MudText>
                        </ItemContent>
                    </MudTimelineItem>
                </MudTimeline>
            </MudPaper>
        </MudItem>

        <!-- Professional Development -->
        <MudItem xs="12">
            <MudPaper Class="pa-4 mt-4">
                <MudText Typo="Typo.h5" GutterBottom="true">Professional Development</MudText>
                <MudGrid>
                    <MudItem xs="12" md="4">
                        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.School">
                            New course available: "Advanced Food Microbiology"
                        </MudAlert>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.CardMembership">
                            Certification renewal due in 60 days
                        </MudAlert>
                    </MudItem>
                    <MudItem xs="12" md="4">
                        <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.Event">
                            Food Safety Conference - Register by @DateTime.Now.AddDays(14).ToString("MMM dd")
                        </MudAlert>
                    </MudItem>
                </MudGrid>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private int _consultationsCompleted = 48;
    private int _consultationsThisMonth = 12;
    private int _certificationsIssued = 156;
    private int _pendingRequests = 5;
    private int _totalReviews = 32;
    private string? _currentUserEmail;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get current user
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            _currentUserEmail = authState.User?.Identity?.Name;

            // These would be fetched from actual consultation/certification tables
            // For now using placeholder values
            
            // In a real implementation, we would:
            // - Get expert profile from database
            // - Count consultations, certifications, etc.
            // - Calculate ratings from reviews
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Database error: {ex.Message}");
        }
    }
}